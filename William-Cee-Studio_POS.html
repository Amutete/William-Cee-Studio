<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>William Cee Studio POS - Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { display: none; }
        .active-screen { display: block; }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Print styles for receipt */
        @media print {
            body * { visibility: hidden; }
            #receipt-modal, #receipt-modal * { visibility: visible; }
            #receipt-modal {
                position: absolute; left: 0; top: 0;
                width: 100%; height: 100%;
                margin: 0; padding: 10px; border: none; box-shadow: none;
            }
            #receipt-controls { display: none; }
        }
        .tab-button.active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .sub-screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 max-w-7xl">

        <div id="login-screen" class="max-w-md mx-auto relative active-screen">
            <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">William Cee Studio</h1>
                <p class="text-gray-500 mb-6">Point of Sale System</p>
                <div id="login-view">
                    <form id="login-form">
                        <div class="mb-4 text-left">
                            <label for="username" class="block text-sm font-medium text-gray-700">Email (Username)</label>
                            <input type="email" id="username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="e.g., admin" required>
                        </div>
                        <div class="mb-4 text-left">
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="••••••••" required>
                        </div>
                        <p id="login-error" class="text-red-500 text-sm mb-4 hidden">Invalid credentials. Please try again.</p>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none transition duration-150">Login</button>
                    </form>
                    <button id="forgot-password-btn" class="text-sm text-blue-600 hover:underline mt-4">Forgot Password?</button>
                </div>
                <div id="forgot-password-view" style="display: none;">
                     <h2 class="text-xl font-bold text-gray-700 mb-4">Password Reset</h2>
                     <p class="text-sm text-gray-600 mb-4">Enter your email address. We will send you a link to reset your password.</p>
                     <form id="forgot-password-form">
                        <div class="mb-4 text-left">
                            <label for="forgot-username" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="forgot-username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="Enter your email" required>
                        </div>
                        <p id="forgot-success" class="text-green-600 text-sm mb-4 hidden">Password reset email sent! Please check your inbox.</p>
                        <p id="forgot-error" class="text-red-500 text-sm mb-4 hidden">Could not find a user with that email.</p>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Request Reset</button>
                    </form>
                     <button id="back-to-login-btn" class="text-sm text-blue-600 hover:underline mt-4">Back to Login</button>
                </div>
            </div>
             <footer class="text-center text-xs text-gray-400 mt-8">
                software created by: CA Creative Solution<br>Tel: +254 790 774 517
            </footer>
        </div>

        <div id="app-container" class="bg-white rounded-xl shadow-lg" style="display: none;">
            <header class="bg-gray-800 text-white p-4 flex justify-between items-center rounded-t-xl">
                <div>
                    <h1 class="text-2xl font-bold">William Cee Studio POS</h1>
                    <p class="text-sm text-gray-300">Welcome, <span id="user-name"></span> (<span id="user-role"></span>) | Branch: <span id="user-branch"></span></p>
                </div>
                <div>
                    <span id="current-time" class="text-sm mr-6"></span>
                    <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Logout</button>
                </div>
            </header>
            
            <main class="p-6 relative min-h-[80vh]">
                <div id="admin-dashboard" class="screen">
                    <div class="flex justify-between items-center mb-6">
                         <h2 class="text-2xl font-bold text-gray-800">Admin Dashboard</h2>
                         <div>
                            <button id="back-to-global-view-btn" style="display:none;" onclick="setBranchView('all')" class="bg-gray-500 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-600 mr-4">← Back to Global View</button>
                             <label for="admin-branch-filter" class="text-sm font-medium">Viewing Branch:</label>
                             <select id="admin-branch-filter" class="ml-2 border-gray-300 rounded-md shadow-sm"></select>
                         </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
                        <div class="bg-blue-100 p-6 rounded-lg"><h3 class="font-bold text-blue-800">Total Revenue Today</h3><p id="admin-total-sales" class="text-3xl font-extrabold text-blue-900 mt-2">KES 0.00</p></div>
                        <div id="expenditure-card" class="bg-orange-100 p-6 rounded-lg cursor-pointer"><h3 class="font-bold text-orange-800">Expenditure Today</h3><p id="admin-expenditure" class="text-3xl font-extrabold text-orange-900 mt-2">KES 0.00</p></div>
                        <div class="bg-green-100 p-6 rounded-lg"><h3 class="font-bold text-green-800">Profit Today</h3><p id="admin-profit" class="text-3xl font-extrabold text-green-900 mt-2">KES 0.00</p></div>
                        <div id="pending-payments-card" class="bg-red-100 p-6 rounded-lg cursor-pointer"><h3 class="font-bold text-red-800">Pending Payments</h3><p id="admin-pending-payments" class="text-3xl font-extrabold text-red-900 mt-2">KES 0.00</p></div>
                        <div id="total-orders-card" class="bg-yellow-100 p-6 rounded-lg cursor-pointer"><h3 class="font-bold text-yellow-800">Total Orders Today</h3><p id="admin-total-orders" class="text-3xl font-extrabold text-yellow-900 mt-2">0</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-xl font-bold mb-4 text-gray-700">Management Controls</h3>
                            <div class="flex flex-wrap gap-4">
                                <button onclick="showScreen('pos-screen', true)" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition">New Sale</button>
                                <button onclick="showScreen('order-management-screen', true)" class="bg-orange-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Manage Orders</button>
                                <button onclick="showScreen('reports-screen', true)" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition">View Reports</button>
                                <button onclick="showScreen('product-management-screen', true)" class="bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Manage Products</button>
                                <button onclick="showScreen('service-management-screen', true)" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition">Manage Services</button>
                                <button onclick="showScreen('staff-management-screen', true)" class="bg-teal-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-700 transition">Manage Staff</button>
                                <button onclick="showScreen('branch-management-screen', true)" class="bg-pink-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-pink-700 transition">Manage Branches</button>
                                <button onclick="showScreen('finance-screen', true)" class="bg-lime-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-lime-700 transition">Finance & Budget</button>
                                <button onclick="showScreen('task-assignment-screen', true)" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">Assign Tasks</button>
                                <button onclick="showScreen('customer-management-screen', true)" class="bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-yellow-600 transition">Customers</button>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                             <h3 class="text-xl font-bold mb-4 text-gray-700">Sales Overview</h3>
                             <div class="space-y-2 text-sm">
                                <div id="admin-tasks-card" class="cursor-pointer"><p><strong>Task Status:</strong> <span id="admin-completed-tasks">0 / 0</span></p></div>
                                <p><strong>Most Popular Service:</strong> <span id="admin-top-service">N/A</span></p>
                                <p><strong>Best Selling Product:</strong> <span id="admin-top-product">N/A</span></p>
                                <p><strong>Peak Hour:</strong> <span id="admin-peak-hour">N/A</span></p>
                             </div>
                        </div>
                    </div>
                </div>

                <div id="staff-dashboard" class="screen">
                     <h2 class="text-2xl font-bold mb-6 text-gray-800">Staff Dashboard</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-6 rounded-lg space-y-4">
                            <h3 class="text-xl font-bold mb-4 text-gray-700">Quick Actions</h3>
                            <button onclick="showScreen('pos-screen', true)" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition text-lg">Start New Sale</button>
                            <button onclick="showScreen('find-order-screen', true)" class="w-full bg-orange-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-600 transition text-lg">Find Order / Clear Balance</button>
                        </div>
                        <div class="bg-blue-50 p-6 rounded-lg h-[60vh] overflow-y-auto">
                            <h3 class="text-xl font-bold mb-4 text-gray-700">Today's Assigned Tasks</h3>
                            <div id="staff-tasks-list" class="space-y-3"><p class="text-gray-500">No tasks assigned for today.</p></div>
                        </div>
                     </div>
                </div>
                
                <div class="absolute top-0 left-0 right-0 bottom-0 bg-white p-6 rounded-xl z-20" id="pos-screen-wrapper" style="display: none;">
                    <div class="sub-screen-header">
                         <h2 class="text-2xl font-bold text-gray-800">New Sale</h2>
                         <button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" onclick="closeSubScreen('pos-screen-wrapper')">← Back to Dashboard</button>
                    </div>
                    <div id="pos-screen" class="h-full flex flex-col">
                        <div class="flex flex-col md:flex-row gap-6 flex-grow min-h-0">
                            <div class="md:w-2/5 bg-gray-50 p-4 rounded-lg flex flex-col">
                                <div class="flex border-b mb-2">
                                    <button id="show-services-btn" class="flex-1 p-2 font-bold bg-blue-500 text-white rounded-t-lg">Services</button>
                                    <button id="show-products-btn" class="flex-1 p-2 font-bold bg-gray-200 text-gray-700 rounded-t-lg">Products</button>
                                </div>
                                <div id="services-list-pos" class="grid grid-cols-2 gap-3 overflow-y-auto flex-grow"></div>
                                <div id="products-list-pos" class="grid grid-cols-2 gap-3 overflow-y-auto flex-grow" style="display: none;"></div>
                            </div>
                            <div class="md:w-3/5 bg-blue-50 p-4 rounded-lg flex flex-col">
                                <h3 class="font-bold text-lg mb-4">Current Order</h3>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                     <input type="text" id="customer-name" class="px-3 py-2 border border-gray-300 rounded-md" placeholder="Customer Name (Required)">
                                     <input type="tel" id="customer-phone" class="px-3 py-2 border border-gray-300 rounded-md" placeholder="Customer Phone (Required)">
                                </div>
                                <div id="cart-items" class="flex-grow space-y-2 overflow-y-auto bg-white p-2 rounded min-h-[150px]"></div>
                                <div class="border-t-2 border-gray-200 mt-4 pt-4">
                                    <div class="flex justify-between items-center text-md mb-2"><span>Subtotal:</span><span id="cart-subtotal">KES 0.00</span></div>
                                    <div class="flex justify-between items-center text-md mb-2">
                                        <span>Discount Applied:</span>
                                        <span id="cart-discount-amount" class="font-semibold text-green-600">KES 0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center text-2xl font-bold mb-4"><span>Total:</span><span id="cart-total">KES 0.00</span></div>
                                    <div class="flex gap-2">
                                        <input type="number" id="payment-amount" placeholder="Amount Paid (Deposit)" class="flex-grow w-1/3 px-3 py-2 border border-gray-300 rounded-md">
                                        <select id="payment-method-select" class="flex-grow w-1/3 px-3 py-2 border border-gray-300 rounded-md">
                                            <option value="">Select Method</option><option value="Cash">Cash</option><option value="M-Pesa">M-Pesa</option><option value="Card">Card</option>
                                        </select>
                                    </div>
                                    <button id="finalize-sale-btn" class="w-full mt-4 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400" disabled>Finalize Sale</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="absolute top-0 left-0 right-0 bottom-0 bg-white p-6 rounded-xl z-20" id="order-management-screen-wrapper" style="display: none;">
                    <div class="sub-screen-header">
                        <h2 class="text-2xl font-bold text-gray-800">Order Management</h2>
                        <button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" onclick="closeSubScreen('order-management-screen-wrapper')">← Back to Dashboard</button>
                    </div>
                    <div id="order-management-screen" class="h-full flex flex-col">
                        <div class="flex-grow overflow-y-auto border rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50 sticky top-0"><tr><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Balance</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead><tbody id="orders-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                    </div>
                </div>

                <div class="absolute top-0 left-0 right-0 bottom-0 bg-white p-6 rounded-xl z-20" id="find-order-screen-wrapper" style="display: none;">
                    <div class="sub-screen-header">
                        <h2 class="text-2xl font-bold text-gray-800">Find Order / Clear Balance</h2>
                        <button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" onclick="closeSubScreen('find-order-screen-wrapper')">← Back to Dashboard</button>
                    </div>
                    <div id="find-order-screen" class="h-full flex flex-col">
                        <div class="flex gap-4 mb-4"><input type="text" id="order-search-input" placeholder="Enter Order ID, Customer Name, or Phone Number" class="flex-grow px-3 py-2 border border-gray-300 rounded-md"><button onclick="handleOrderSearch()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Search</button></div>
                        <div id="order-search-results" class="flex-grow overflow-y-auto border rounded-lg bg-gray-50 p-4"><p class="text-gray-500">Search for an order to see results.</p></div>
                    </div>
                </div>
                
                <div class="absolute top-0 left-0 right-0 bottom-0 bg-white p-6 rounded-xl z-20" id="reports-screen-wrapper" style="display: none;">
                    <div class="sub-screen-header">
                        <h2 class="text-2xl font-bold text-gray-800">Sales Report</h2>
                        <button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" onclick="closeSubScreen('reports-screen-wrapper')">← Back to Dashboard</button>
                    </div>
                    <div id="reports-screen" class="h-full flex flex-col">
                         <div class="flex justify-between items-center mb-4 gap-2">
                            <div class="flex items-center gap-2">
                                <label for="report-start-date">From:</label><input type="date" id="report-start-date" class="border-gray-300 rounded-md p-1">
                                <label for="report-end-date">To:</label><input type="date" id="report-end-date" class="border-gray-300 rounded-md p-1">
                                <span class="font-semibold ml-4 mr-2">Status:</span>
                                <select id="report-status-filter" class="border-gray-300 rounded-md p-1"><option value="all">All</option><option value="fully-paid">Fully Paid</option><option value="deposit-paid">Deposit Paid</option></select>
                                <button onclick="renderReports()" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">Apply Filter</button>
                            </div>
                            <button onclick="downloadReport()" class="bg-green-500 text-white px-4 py-2 rounded-md text-sm hover:bg-green-600">Download Report (CSV)</button>
                        </div>
                        <div class="flex-grow overflow-y-auto border rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50 sticky top-0"><tr><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Order#</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Staff</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Paid</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Balance</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Cleared By</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Cleared On</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase">Branch</th></tr></thead><tbody id="reports-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                    </div>
                </div>

                <div id="product-management-screen-wrapper" class="absolute top-0 left-0 right-0 bottom-0 bg-white p-6 rounded-xl z-20" style="display: none;"><div class="sub-screen-header"><h2 class="text-2xl font-bold text-gray-800">Manage Products</h2><button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" onclick="closeSubScreen('product-management-screen-wrapper')">← Back to Dashboard</button></div><div id="product-management-screen" class="h-full overflow-y-auto"></div></div>
                <div id="service-management-screen-wrapper" class="absolute top-0 left-0 right-0 bottom-0 bg-white p-6 rounded-xl z-20" style="display: none;"><div class="sub-screen-header"><h2 class="text-2xl font-bold text-gray-800">Manage Services</h2><button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" onclick="closeSubScreen('service-management-screen-wrapper')">← Back to Dashboard</button></div><div id="service-management-screen" class="h-full overflow-y-auto"></div></div>
                <div id="staff-management-screen-wrapper" class="absolute top-0 left-0 right-0 bottom-0 bg-white p-6 rounded-xl z-20" style="display: none;"><div class="sub-screen-header"><h2 class="text-2xl font-bold text-gray-800">Manage Staff</h2><button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" onclick="closeSubScreen('staff-management-screen-wrapper')">← Back to Dashboard</button></div><div id="staff-management-screen" class="h-full overflow-y-auto"></div></div>
                <div id="branch-management-screen-wrapper" class="absolute top-0 left-0 right-0 bottom-0 bg-white p-6 rounded-xl z-20" style="display: none;"><div class="sub-screen-header"><h2 class="text-2xl font-bold text-gray-800">Manage Branches</h2><button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" onclick="closeSubScreen('branch-management-screen-wrapper')">← Back to Dashboard</button></div><div id="branch-management-screen" class="h-full overflow-y-auto"></div></div>
                <div id="finance-screen-wrapper" class="absolute top-0 left-0 right-0 bottom-0 bg-white p-6 rounded-xl z-20" style="display: none;"><div class="sub-screen-header"><h2 class="text-2xl font-bold text-gray-800">Finance & Budget</h2><button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" onclick="closeSubScreen('finance-screen-wrapper')">← Back to Dashboard</button></div><div id="finance-screen" class="h-full overflow-y-auto"></div></div>
                <div id="task-assignment-screen-wrapper" class="absolute top-0 left-0 right-0 bottom-0 bg-white p-6 rounded-xl z-20" style="display: none;"><div class="sub-screen-header"><h2 class="text-2xl font-bold text-gray-800">Assign & Manage Tasks</h2><button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" onclick="closeSubScreen('task-assignment-screen-wrapper')">← Back to Dashboard</button></div><div id="task-assignment-screen" class="h-full overflow-y-auto"></div></div>
                <div id="customer-management-screen-wrapper" class="absolute top-0 left-0 right-0 bottom-0 bg-white p-6 rounded-xl z-20" style="display: none;"><div class="sub-screen-header"><h2 class="text-2xl font-bold text-gray-800">Manage Customers</h2><button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600" onclick="closeSubScreen('customer-management-screen-wrapper')">← Back to Dashboard</button></div><div id="customer-management-screen" class="h-full overflow-y-auto"></div></div>
                
                 <footer class="text-center text-xs text-gray-400 mt-8 absolute bottom-4 left-0 right-0">software created by: CA Creative Solution<br>Tel: +254 790 774 517</footer>
            </main>
        </div>

        <div id="pay-balance-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-40"><div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-auto"><h2 class="text-xl font-bold mb-4">Pay Balance</h2><div id="pay-balance-content"></div><div class="mt-6 flex justify-end gap-4"><button onclick="closePayBalanceModal()" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button><button id="process-balance-payment-btn" onclick="processBalancePayment()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Process Payment</button></div></div></div>
        <div id="receipt-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50"><div id="receipt-modal" class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-auto font-mono text-sm text-black"><div id="receipt-content"><div class="text-center mb-4"><h2 class="font-bold text-lg">WILLIAM CEE STUDIO</h2><p id="receipt-branch-name"></p><p id="receipt-branch-location">2nd Floor, Biashara Plaza, Naivasha Town</p><p>Tel: +254 716 912 114</p></div><div class="border-t border-b border-dashed border-black py-2 my-2"><p>Receipt #: <span id="receipt-id"></span></p><p>Date: <span id="receipt-date"></span></p><p>Served by: <span id="receipt-user"></span></p></div><table class="w-full mb-2"><thead><tr><th class="text-left">QTY</th><th class="text-left">ITEM</th><th class="text-right">PRICE</th></tr></thead><tbody id="receipt-items"></tbody></table><div class="border-t-2 border-dashed border-black mt-2 pt-2" id="receipt-payment-summary"></div></div><div class="text-center text-xs mt-4"><p>software created by: CA Creative Solution</p><p>Tel: +254 790 774 517</p></div><div id="receipt-controls" class="mt-6 flex flex-wrap gap-2"><div class="w-full text-center text-red-600 font-semibold mb-2 text-xs">NOTE: Please print TWO copies. One for the customer, one for the business.</div><button onclick="handlePrint()" class="flex-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Print</button><button onclick="downloadReceiptAsPDF()" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Download PDF</button><button onclick="closeReceipt()" class="w-full mt-2 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Close</button></div></div></div>
        <div id="alert-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50"><div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full mx-auto text-center"><p id="alert-message" class="text-lg mb-6"></p><button onclick="closeAlertModal()" class="bg-blue-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-700">OK</button></div></div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>


    <script>
        const { jsPDF } = window.jspdf;
        
        // ===============================================================================
        // PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE                                 
        // ===============================================================================
        // To get this object:
        // 1. Go to your Firebase project console.
        // 2. Click the gear icon > Project settings.
        // 3. In the "General" tab, scroll down to "Your apps".
        // 4. If you haven't created a web app, click the "</>" icon to create one.
        // 5. Copy the `firebaseConfig` object and paste it below.
        
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ===============================================================================
        // APP STATE (Client-side cache of database data)
        // ===============================================================================
        let data = {
            users: [], services: [], products: [], tasks: [],
            orders: [], customers: [], branches: [], transactions: [],
            budgets: { business: [], personal: [] },
        };
        let currentUser = null; // Holds profile info from Firestore 'users' collection
        let currentBranchId = 'all'; // Admin's current view scope
        let cart = [];
        let currentOrderForBalancePayment = null;
        
        // --- DOM ELEMENTS & GLOBAL LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeLoginScreen();
            setupDashboardCardListeners();
        });
        
        // --- UTILITY FUNCTIONS ---
        function formatCurrency(amount) { return `KES ${Number(amount || 0).toFixed(2)}`; }
        function formatDateTime(timestamp) { if(!timestamp) return 'N/A'; return new Date(timestamp).toLocaleString('en-KE', { dateStyle: 'short', timeStyle: 'short' }); }
        function formatDate(timestamp) { if(!timestamp) return 'N/A'; return new Date(timestamp).toLocaleDateString('en-CA'); } // YYYY-MM-DD
        function updateTime() { document.getElementById('current-time').textContent = new Date().toLocaleString('en-KE', { dateStyle: 'medium', timeStyle: 'short' }); }
        function showAlert(message) {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-modal-overlay').style.display = 'flex';
        }
        function closeAlertModal() { document.getElementById('alert-modal-overlay').style.display = 'none'; }
        
        // --- DATA FETCHING FROM FIREBASE ---
        async function fetchAllData() {
            showAlert("Loading data from server...");
            const collections = ['users', 'services', 'products', 'tasks', 'orders', 'customers', 'branches', 'transactions'];
            const fetchPromises = collections.map(async (col) => {
                const snapshot = await db.collection(col).get();
                return { name: col, docs: snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) };
            });

            const results = await Promise.all(fetchPromises);
            results.forEach(result => {
                data[result.name] = result.docs;
            });
            
            // Fetch budgets separately as they are structured differently
            const budgetSnapshot = await db.collection('budgets').doc('business').get();
            if(budgetSnapshot.exists) data.budgets.business = budgetSnapshot.data().categories || [];

            closeAlertModal();
            return true;
        }

        // --- SCREEN MANAGEMENT ---
        function showScreen(screenId, isSubScreen = false) {
            const renderMap = {
                'admin-dashboard': renderAdminDashboard, 'staff-dashboard': renderStaffDashboard,
                'pos-screen': renderPosScreen, 'order-management-screen': renderOrderManagement,
                'find-order-screen': renderFindOrderScreen, 'reports-screen': renderReports,
                'product-management-screen': renderProductManagement, 'service-management-screen': renderServiceManagement,
                'staff-management-screen': renderStaffManagement, 'branch-management-screen': renderBranchManagement,
                'finance-screen': renderFinanceScreen, 'task-assignment-screen': renderTaskAssignment,
                'customer-management-screen': renderCustomerManagement,
            };
            
            if (isSubScreen) {
                document.getElementById(`${screenId}-wrapper`).style.display = 'block';
            } else {
                 document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
                 document.getElementById(screenId)?.classList.add('active-screen');
            }
            renderMap[screenId]?.(); // Render the screen's content
        }
        function closeSubScreen(wrapperId) { 
            document.getElementById(wrapperId).style.display = 'none'; 
            showScreen(currentUser.role === 'admin' ? 'admin-dashboard' : 'staff-dashboard');
        }

        // --- AUTHENTICATION & LOGIN (Firebase) ---
        function initializeLoginScreen() {
             document.getElementById('login-screen').style.display = 'block';
             document.getElementById('app-container').style.display = 'none';
             document.getElementById('forgot-password-btn').addEventListener('click', () => {
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('forgot-password-view').style.display = 'block';
            });
            document.getElementById('back-to-login-btn').addEventListener('click', () => {
                document.getElementById('forgot-password-view').style.display = 'none';
                document.getElementById('login-view').style.display = 'block';
            });
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Fetch user profile from Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    throw new Error("User profile not found in database.");
                }
                currentUser = { id: user.uid, ...userDoc.data() };
                
                // Fetch all business data after successful login
                await fetchAllData();

                if (currentUser.role === 'admin') {
                    currentBranchId = 'all'; // Admin starts with global view
                } else {
                    currentBranchId = currentUser.branchId; // Staff is locked to their branch
                }
                
                document.getElementById('login-error').classList.add('hidden');
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                document.getElementById('user-name').textContent = currentUser.fullName;
                document.getElementById('user-role').textContent = currentUser.rolePosition;
                updateBranchDisplay();
                
                showScreen(currentUser.role === 'admin' ? 'admin-dashboard' : 'staff-dashboard');
            } catch (error) {
                console.error("Login failed:", error);
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        async function handleForgotPassword(e) { 
            e.preventDefault(); 
            const email = document.getElementById('forgot-username').value;
            try {
                await auth.sendPasswordResetEmail(email);
                document.getElementById('forgot-error').classList.add('hidden');
                document.getElementById('forgot-success').classList.remove('hidden');
            } catch (error) {
                console.error("Password reset failed:", error);
                document.getElementById('forgot-success').classList.add('hidden');
                document.getElementById('forgot-error').classList.remove('hidden');
            }
        }

        document.getElementById('logout-button').addEventListener('click', async () => {
            await auth.signOut();
            currentUser = null; currentBranchId = null; cart = [];
            data = {}; // Clear cached data
            document.getElementById('login-form').reset();
            initializeLoginScreen();
        });

        // --- RECEIPT & PRINTING ---
        function showReceipt(order) {
            const user = data.users.find(u => u.id === order.staffId);
            const branch = data.branches.find(b => b.id === order.branchId);

            document.getElementById('receipt-branch-name').textContent = branch?.name || 'Main Branch';
            document.getElementById('receipt-branch-location').textContent = branch?.location ? `${branch.location}, Naivasha Town` : '2nd Floor, Biashara Plaza, Naivasha Town';
            document.getElementById('receipt-id').textContent = order.displayId;
            document.getElementById('receipt-date').textContent = formatDateTime(order.timestamp);
            document.getElementById('receipt-user').textContent = user?.fullName || 'N/A';
            
            document.getElementById('receipt-items').innerHTML = order.items.map(item => `
                <tr>
                    <td>${item.quantity}x</td>
                    <td>${item.name}</td>
                    <td class="text-right">${formatCurrency(item.price * item.quantity)}</td>
                </tr>
            `).join('');

            document.getElementById('receipt-payment-summary').innerHTML = `
                <div class="flex justify-between"><span>Subtotal:</span><span>${formatCurrency(order.subtotal)}</span></div>
                <div class="flex justify-between"><span>Discount:</span><span>(${order.discountPercent}%)</span></div>
                <div class="flex justify-between font-bold"><span>Total:</span><span>${formatCurrency(order.total)}</span></div>
                <div class="border-t border-dashed my-1"></div>
                <div class="flex justify-between"><span>Amount Paid:</span><span>${formatCurrency(order.amountPaid)}</span></div>
                <div class="flex justify-between font-bold"><span>Balance Due:</span><span>${formatCurrency(order.balance)}</span></div>
            `;
            
            document.getElementById('receipt-modal-overlay').style.display = 'flex';
        }
        function handlePrint() { window.print(); }
        async function downloadReceiptAsPDF() {
            const receiptContent = document.getElementById("receipt-modal");
            const receiptId = document.getElementById('receipt-id').textContent;
            showAlert("Generating PDF... Please wait.");

            try {
                const canvas = await html2canvas(receiptContent, { scale: 3, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const pdfWidth = 80; // mm for thermal printer style
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [pdfWidth, pdfHeight]
                });

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Receipt-${receiptId}.pdf`);
            } catch (err) {
                showAlert("Sorry, could not generate PDF. Please try again.");
                console.error("PDF generation failed:", err);
            }
            closeAlertModal();
        }
        function closeReceipt() { document.getElementById('receipt-modal-overlay').style.display = 'none'; }


        // --- DASHBOARD ---
        function setupDashboardCardListeners() {
            document.getElementById('pending-payments-card').addEventListener('click', () => showScreen('order-management-screen', true));
            document.getElementById('total-orders-card').addEventListener('click', () => showScreen('order-management-screen', true));
            document.getElementById('expenditure-card').addEventListener('click', () => showScreen('finance-screen', true));
            document.getElementById('admin-tasks-card').addEventListener('click', () => showScreen('task-assignment-screen', true));
        }

        function setBranchView(branchId) {
            currentBranchId = branchId === 'all' ? 'all' : branchId;
            updateBranchDisplay();
            renderAdminDashboard();
        }

        function updateBranchDisplay() {
            const branchName = currentBranchId === 'all' 
                ? 'All Branches' 
                : (data.branches.find(b => b.id == currentBranchId)?.name || 'N/A');
            document.getElementById('user-branch').textContent = branchName;
        }

        function renderAdminDashboard() {
            const branchFilter = document.getElementById('admin-branch-filter');
            branchFilter.innerHTML = `<option value="all">All Branches</option>` + data.branches.map(b => `<option value="${b.id}" ${currentBranchId == b.id ? 'selected' : ''}>${b.name}</option>`).join('');
            branchFilter.onchange = (e) => setBranchView(e.target.value);

            document.getElementById('back-to-global-view-btn').style.display = currentBranchId !== 'all' ? 'inline-block' : 'none';

            const today = new Date().toDateString();
            const filterByBranch = (item) => currentBranchId === 'all' || item.branchId == currentBranchId;

            const ordersToday = data.orders.filter(o => new Date(o.timestamp).toDateString() === today && filterByBranch(o));
            const expendituresToday = data.transactions.filter(t => new Date(t.date).toDateString() === today && t.type === 'business' && t.transactionType === 'expense' && filterByBranch(t));
            
            const totalSales = ordersToday.reduce((sum, order) => sum + order.amountPaid, 0);
            const totalExpenditure = expendituresToday.reduce((sum, exp) => sum + exp.amount, 0);
            const profit = totalSales - totalExpenditure;
            const pendingPayments = data.orders.filter(o => o.balance > 0 && filterByBranch(o)).reduce((sum, order) => sum + order.balance, 0);
            const tasks = data.tasks.filter(filterByBranch);
            const completedTasks = tasks.filter(t => t.status === 'Completed').length;

            document.getElementById('admin-total-sales').textContent = formatCurrency(totalSales);
            document.getElementById('admin-expenditure').textContent = formatCurrency(totalExpenditure);
            document.getElementById('admin-profit').textContent = formatCurrency(profit);
            document.getElementById('admin-pending-payments').textContent = formatCurrency(pendingPayments);
            document.getElementById('admin-total-orders').textContent = ordersToday.length;
            document.getElementById('admin-completed-tasks').textContent = `${completedTasks} / ${tasks.length}`;
            
            const itemCounter = (items) => items.reduce((acc, item) => { acc[item.name] = (acc[item.name] || 0) + 1; return acc; }, {});
            const serviceCounts = itemCounter(ordersToday.flatMap(o => o.items.filter(i => i.type === 'service')));
            const productCounts = itemCounter(ordersToday.flatMap(o => o.items.filter(i => i.type === 'product')));
            const getTopItem = (counts) => Object.keys(counts).length ? Object.entries(counts).sort((a,b) => b[1] - a[1])[0][0] : 'N/A';

            document.getElementById('admin-top-service').textContent = getTopItem(serviceCounts);
            document.getElementById('admin-top-product').textContent = getTopItem(productCounts);

            const hourCounts = ordersToday.reduce((acc, order) => {
                const hour = new Date(order.timestamp).getHours();
                acc[hour] = (acc[hour] || 0) + 1; return acc;
            }, {});
            const peakHour = Object.keys(hourCounts).length ? Object.entries(hourCounts).sort((a,b) => b[1] - a[1])[0][0] : 'N/A';
            document.getElementById('admin-peak-hour').textContent = peakHour !== 'N/A' ? `${peakHour}:00 - ${parseInt(peakHour)+1}:00` : 'N/A';
        }

        function renderStaffDashboard() { 
            const tasksContainer = document.getElementById('staff-tasks-list');
            const staffTasks = data.tasks.filter(t => t.staffId === currentUser.id);
            if (staffTasks.length > 0) {
                 tasksContainer.innerHTML = staffTasks.map(task => `
                    <div class="bg-white p-3 rounded-lg border">
                        <p class="font-bold">${task.title} <span class="text-xs text-gray-500">(Due: ${task.dueDate})</span></p>
                        <p class="text-sm text-gray-600">${task.notes}</p>
                        <div class="mt-2">
                            <select class="border rounded p-1 text-sm" onchange="updateTaskStatus('${task.id}', this.value)">
                                <option value="Pending" ${task.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                <option value="Rejected" ${task.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                            </select>
                        </div>
                    </div>
                `).join('');
            } else {
                 tasksContainer.innerHTML = `<p class="text-gray-500">No tasks assigned.</p>`;
            }
        }
        
        // --- POS (NEW SALE) SCREEN ---
        function renderPosScreen() {
            cart = [];
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('payment-amount').value = '';

            const servicesContainer = document.getElementById('services-list-pos');
            const productsContainer = document.getElementById('products-list-pos');
            const userBranchId = currentUser.role === 'admin' ? (currentBranchId === 'all' ? data.branches[0].id : currentBranchId) : currentUser.branchId;
            const branchServices = data.services.filter(s => s.branchId === userBranchId);
            const branchProducts = data.products.filter(p => p.branchId === userBranchId);

            servicesContainer.innerHTML = branchServices.map(s => `
                <div class="p-2 border rounded-lg bg-white cursor-pointer hover:bg-blue-100" onclick="addToCart('${s.id}', 'service')">
                    <p class="font-semibold">${s.name}</p>
                    <p class="text-sm text-gray-600">${formatCurrency(s.basePrice)}</p>
                </div>`).join('');
            
            productsContainer.innerHTML = branchProducts.map(p => `
                <div class="p-2 border rounded-lg bg-white cursor-pointer hover:bg-blue-100 ${p.stock <= 0 ? 'opacity-50 cursor-not-allowed' : ''}" 
                     onclick="${p.stock > 0 ? `addToCart('${p.id}', 'product')` : ''}">
                    <p class="font-semibold">${p.name}</p>
                    <p class="text-sm text-gray-600">${formatCurrency(p.basePrice)} (Stock: ${p.stock})</p>
                </div>`).join('');

            document.getElementById('show-services-btn').onclick = () => {
                document.getElementById('services-list-pos').style.display = 'grid'; document.getElementById('products-list-pos').style.display = 'none';
                document.getElementById('show-services-btn').classList.add('bg-blue-500', 'text-white'); document.getElementById('show-services-btn').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('show-products-btn').classList.add('bg-gray-200', 'text-gray-700'); document.getElementById('show-products-btn').classList.remove('bg-blue-500', 'text-white');
            };
            document.getElementById('show-products-btn').onclick = () => {
                document.getElementById('services-list-pos').style.display = 'none'; document.getElementById('products-list-pos').style.display = 'grid';
                document.getElementById('show-products-btn').classList.add('bg-blue-500', 'text-white'); document.getElementById('show-products-btn').classList.remove('bg-gray-200', 'text-gray-700');
                document.getElementById('show-services-btn').classList.add('bg-gray-200', 'text-gray-700'); document.getElementById('show-services-btn').classList.remove('bg-blue-500', 'text-white');
            };

            document.getElementById('finalize-sale-btn').onclick = handleFinalizeSale;
            document.getElementById('customer-name').oninput = renderCart;
            document.getElementById('customer-phone').oninput = renderCart;
            renderCart();
        }

        function addToCart(itemId, type) {
            const existingItem = cart.find(item => item.id === itemId && item.type === type);
            if (existingItem) {
                if (type === 'product') {
                    const product = data.products.find(p => p.id === itemId);
                    if (existingItem.quantity < product.stock) {
                        existingItem.quantity++;
                    } else {
                        showAlert('Cannot add more than available stock.');
                    }
                } else {
                     existingItem.quantity++;
                }
            } else {
                const sourceItem = type === 'service' ? data.services.find(s => s.id === itemId) : data.products.find(p => p.id === itemId);
                let price = sourceItem.basePrice;
                if (sourceItem.flashSalePrice && sourceItem.flashSalePrice > 0) {
                    price = sourceItem.flashSalePrice;
                } else if (sourceItem.discountPercent && sourceItem.discountPercent > 0) {
                    price = sourceItem.basePrice * (1 - sourceItem.discountPercent / 100);
                }
                cart.push({ ...sourceItem, type, quantity: 1, price: price });
            }
            renderCart();
        }
        function removeFromCart(cartIndex) { cart.splice(cartIndex, 1); renderCart(); }
        function updateCartQuantity(cartIndex, change) {
            const item = cart[cartIndex];
            const newQuantity = item.quantity + change;
            if (newQuantity <= 0) {
                removeFromCart(cartIndex);
            } else {
                if (item.type === 'product') {
                    const product = data.products.find(p => p.id === item.id);
                    if (newQuantity <= product.stock) {
                        item.quantity = newQuantity;
                    } else {
                         showAlert('Cannot add more than available stock.');
                    }
                } else { item.quantity = newQuantity; }
            }
            renderCart();
        }
        function renderCart() {
            const cartContainer = document.getElementById('cart-items');
            cartContainer.innerHTML = cart.length === 0 
                ? '<p class="text-gray-500 text-center">Your cart is empty.</p>'
                : cart.map((item, index) => `
                    <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm">
                        <div>
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-sm text-gray-600">${formatCurrency(item.price)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="px-2 bg-gray-200 rounded" onclick="updateCartQuantity(${index}, -1)">-</button>
                            <span>${item.quantity}</span>
                            <button class="px-2 bg-gray-200 rounded" onclick="updateCartQuantity(${index}, 1)">+</button>
                            <button class="text-red-500 hover:text-red-700 ml-2" onclick="removeFromCart(${index})">&times;</button>
                        </div>
                    </div>`).join('');
            
            const subtotal = cart.reduce((sum, item) => sum + (item.basePrice * item.quantity), 0);
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discountAmount = subtotal - total;

            document.getElementById('cart-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('cart-discount-amount').textContent = formatCurrency(discountAmount);
            document.getElementById('cart-total').textContent = formatCurrency(total);

            const finalizeBtn = document.getElementById('finalize-sale-btn');
            const customerName = document.getElementById('customer-name').value;
            const customerPhone = document.getElementById('customer-phone').value;
            finalizeBtn.disabled = cart.length === 0 || !customerName || !customerPhone;
        }

        async function handleFinalizeSale() {
            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();
            const paymentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
            const paymentMethod = document.getElementById('payment-method-select').value;
            
            const subtotal = cart.reduce((sum, item) => sum + (item.basePrice * item.quantity), 0);
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discountAmount = subtotal - total;
            const discountPercent = subtotal > 0 ? (discountAmount / subtotal) * 100 : 0;

            if (!customerName || !customerPhone) { showAlert("Customer Name and Phone are required."); return; }
            if (cart.length === 0) { showAlert("Cart is empty."); return; }
            if (paymentAmount > 0 && !paymentMethod) { showAlert("Please select a payment method."); return; }
            if (paymentAmount > total) { showAlert("Payment amount cannot be greater than the total."); return; }
            
            const balance = total - paymentAmount;
            const status = balance <= 0.01 ? 'fully-paid' : 'deposit-paid';
            const userBranchId = currentUser.role === 'admin' ? (currentBranchId === 'all' ? data.branches[0].id : currentBranchId) : currentUser.branchId;

            let customerId;
            let customer = data.customers.find(c => c.phone === customerPhone);
            if (!customer) {
                const newCustomer = { name: customerName, phone: customerPhone, email: '', customerType: 'Walk-in', branchId: userBranchId, totalSpent: total, loyaltyPoints: Math.floor(total / 100), lastPurchase: new Date().toISOString() };
                const docRef = await db.collection('customers').add(newCustomer);
                customerId = docRef.id;
            } else {
                customerId = customer.id;
                const updatedSpent = (customer.totalSpent || 0) + total;
                const updatedPoints = (customer.loyaltyPoints || 0) + Math.floor(total / 100);
                await db.collection('customers').doc(customerId).update({
                    name: customerName,
                    totalSpent: updatedSpent,
                    loyaltyPoints: updatedPoints,
                    lastPurchase: new Date().toISOString()
                });
            }
            
            const counterRef = db.collection('counters').doc('orders');
            const newDisplayId = await db.runTransaction(async (transaction) => {
                const counterDoc = await transaction.get(counterRef);
                const newCount = (counterDoc.data()?.count || 1023) + 1;
                transaction.update(counterRef, { count: newCount });
                return newCount;
            });

            const newOrder = {
                displayId: newDisplayId,
                timestamp: new Date().toISOString(),
                customerId: customerId,
                staffId: currentUser.id,
                branchId: userBranchId,
                items: JSON.parse(JSON.stringify(cart)), 
                subtotal: subtotal,
                discountPercent: discountPercent.toFixed(2),
                total: total,
                amountPaid: paymentAmount,
                balance: balance,
                status: status,
                payments: paymentAmount > 0 ? [{ amount: paymentAmount, method: paymentMethod, date: new Date().toISOString(), staffId: currentUser.id }] : [],
                balanceClearances: []
            };
            
            await db.collection('orders').add(newOrder);

            const batch = db.batch();
            cart.forEach(cartItem => {
                if (cartItem.type === 'product') {
                    const productRef = db.collection('products').doc(cartItem.id);
                    batch.update(productRef, { stock: firebase.firestore.FieldValue.increment(-cartItem.quantity) });
                }
            });
            await batch.commit();

            if (paymentAmount > 0) {
                await db.collection('transactions').add({
                    type: 'business', transactionType: 'income', category: 'Sales Revenue',
                    description: `Sale from Order #${newDisplayId}`, amount: paymentAmount, date: new Date().toISOString().split('T')[0],
                    branchId: userBranchId, paymentMethod: paymentMethod
                });
            }

            await fetchAllData();
            showReceipt(newOrder);
            closeSubScreen('pos-screen-wrapper');
        }

        // --- ORDER MANAGEMENT & BALANCE PAYMENT ---
        function renderOrderManagement() {
            const tableBody = document.getElementById('orders-table-body');
            const ordersToDisplay = (currentBranchId === 'all') 
                ? data.orders 
                : data.orders.filter(o => o.branchId == currentBranchId);
            
            tableBody.innerHTML = ordersToDisplay.sort((a,b) => b.displayId - a.displayId).map(order => {
                const customer = data.customers.find(c => c.id === order.customerId);
                const balanceColor = order.balance > 0 ? 'text-red-600 font-bold' : 'text-green-600';
                return `
                    <tr>
                        <td class="p-3">${order.displayId}</td>
                        <td class="p-3">${customer?.name || 'N/A'}</td>
                        <td class="p-3">${formatDateTime(order.timestamp)}</td>
                        <td class="p-3">${formatCurrency(order.total)}</td>
                        <td class="p-3 ${balanceColor}">${formatCurrency(order.balance)}</td>
                        <td class="p-3"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${order.status === 'fully-paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${order.status}</span></td>
                        <td class="p-3">${order.balance > 0.01 ? `<button class="text-blue-600 hover:underline" onclick="openPayBalanceModal('${order.id}')">Pay Balance</button>` : 'Cleared'}</td>
                    </tr>
                `
            }).join('');
        }

        function handleOrderSearch() {
             const query = document.getElementById('order-search-input').value.toLowerCase();
             if (!query) return;
             const results = data.orders.filter(order => {
                const customer = data.customers.find(c => c.id === order.customerId);
                return order.displayId.toString().includes(query) ||
                       customer?.name.toLowerCase().includes(query) ||
                       customer?.phone.includes(query);
             });
             const resultsContainer = document.getElementById('order-search-results');
             resultsContainer.innerHTML = results.length > 0 ? results.map(order => {
                 const customer = data.customers.find(c => c.id === order.customerId);
                 return `<div class="p-3 border-b">
                            <p><strong>Order ID:</strong> ${order.displayId} | <strong>Customer:</strong> ${customer?.name} (${customer?.phone})</p>
                            <p><strong class="text-red-600">Balance: ${formatCurrency(order.balance)}</strong></p>
                            ${order.balance > 0.01 ? `<button class="text-blue-600 hover:underline mt-1" onclick="openPayBalanceModal('${order.id}')">Clear Balance</button>` : '<span class="text-green-600">Fully Paid</span>'}
                         </div>`;
             }).join('') : '<p class="text-gray-500">No orders found.</p>';
        }

        function openPayBalanceModal(orderId) {
            currentOrderForBalancePayment = data.orders.find(o => o.id === orderId);
            if (!currentOrderForBalancePayment) return;
            const content = document.getElementById('pay-balance-content');
            content.innerHTML = `
                <p><strong>Order ID:</strong> ${currentOrderForBalancePayment.displayId}</p>
                <p><strong>Current Balance:</strong> <span class="font-bold text-red-600">${formatCurrency(currentOrderForBalancePayment.balance)}</span></p>
                <div class="mt-4">
                    <label class="block text-sm font-medium">Amount to Pay</label>
                    <input type="number" id="balance-payment-amount" value="${currentOrderForBalancePayment.balance.toFixed(2)}" class="mt-1 w-full border rounded p-2">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Payment Method</label>
                    <select id="balance-payment-method" class="mt-1 w-full border rounded p-2">
                        <option value="Cash">Cash</option><option value="M-Pesa">M-Pesa</option><option value="Card">Card</option>
                    </select>
                </div>
            `;
            document.getElementById('pay-balance-modal-overlay').style.display = 'flex';
        }
        function closePayBalanceModal() { document.getElementById('pay-balance-modal-overlay').style.display = 'none'; currentOrderForBalancePayment = null; }
        async function processBalancePayment() {
            const amount = parseFloat(document.getElementById('balance-payment-amount').value);
            const method = document.getElementById('balance-payment-method').value;
            
            if (!amount || amount <= 0) { showAlert("Invalid payment amount."); return; }
            if (amount > currentOrderForBalancePayment.balance + 0.01) { showAlert("Payment cannot exceed balance."); return; }
            
            const clearanceRecord = { amount: amount, method: method, date: new Date().toISOString(), staffId: currentUser.id };
            const newBalance = currentOrderForBalancePayment.balance - amount;
            const newStatus = newBalance <= 0.01 ? 'fully-paid' : currentOrderForBalancePayment.status;

            await db.collection('orders').doc(currentOrderForBalancePayment.id).update({
                amountPaid: firebase.firestore.FieldValue.increment(amount),
                balance: newBalance <= 0.01 ? 0 : newBalance,
                status: newStatus,
                payments: firebase.firestore.FieldValue.arrayUnion(clearanceRecord),
                balanceClearances: firebase.firestore.FieldValue.arrayUnion(clearanceRecord),
            });
            
            await db.collection('transactions').add({
                type: 'business', transactionType: 'income', category: 'Sales Revenue',
                description: `Balance payment for Order #${currentOrderForBalancePayment.displayId}`, amount: amount, date: new Date().toISOString().split('T')[0],
                branchId: currentOrderForBalancePayment.branchId, paymentMethod: method
            });

            await fetchAllData();
            showAlert("Payment successful!");
            closePayBalanceModal();
            if(document.getElementById('order-management-screen-wrapper').style.display === 'block') renderOrderManagement();
            if(document.getElementById('find-order-screen-wrapper').style.display === 'block') handleOrderSearch();
        }

        // --- FINANCE & BUDGET (REVAMPED) ---
        function renderFinanceScreen() {
            const container = document.getElementById('finance-screen');
            container.innerHTML = `<div id="finance-business-view"></div>`; // Simplified to just business view
            renderBusinessFinance();
        }

        function renderBusinessFinance() {
            const container = document.getElementById('finance-business-view');
            const transactions = data.transactions.filter(t => t.type === 'business');
            const income = transactions.filter(t => t.transactionType === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.transactionType === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const profit = income - expenses;
            const expenseCategories = ['Equipment Purchases', 'Rent & Utilities', 'Salaries/Wages', 'Marketing', 'Transport/Fuel', 'Miscellaneous', 'Other Income', 'Sales Revenue'];
            const branchOptions = data.branches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-green-100 p-4 rounded-lg shadow-sm"><h4 class="font-bold text-green-800">Total Income</h4><p class="text-2xl font-semibold">${formatCurrency(income)}</p></div>
                    <div class="bg-red-100 p-4 rounded-lg shadow-sm"><h4 class="font-bold text-red-800">Total Expenses</h4><p class="text-2xl font-semibold">${formatCurrency(expenses)}</p></div>
                    <div class="bg-blue-100 p-4 rounded-lg shadow-sm"><h4 class="font-bold text-blue-800">Net Profit/Savings</h4><p class="text-2xl font-semibold">${formatCurrency(profit)}</p></div>
                </div>

                <h3 class="text-xl font-bold mb-4 text-gray-700">Budget vs. Actual</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    ${data.budgets.business.map(b => {
                        const spent = transactions.filter(t => t.category === b.category && t.transactionType === 'expense').reduce((s, t) => s + t.amount, 0);
                        const remaining = b.amount - spent;
                        const remainingColor = remaining >= 0 ? 'text-green-600' : 'text-red-600';
                        return `
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-bold">${b.category}</h4>
                            <div class="text-sm space-y-1 mt-2">
                                <p><strong>Budget:</strong> ${formatCurrency(b.amount)}</p>
                                <p><strong>Actual:</strong> ${formatCurrency(spent)}</p>
                                <p><strong>Remaining:</strong> <span class="font-bold ${remainingColor}">${formatCurrency(remaining)}</span></p>
                            </div>
                        </div>`
                    }).join('') || '<p class="text-gray-500">No budgets set.</p>'}
                </div>

                <div class="bg-gray-50 p-4 rounded-lg border mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-700">Add New Transaction</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <select id="new-tx-type" class="border rounded p-2"><option value="expense">Expense</option><option value="income">Income</option></select>
                        <select id="new-tx-category" class="border rounded p-2">${expenseCategories.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                        <input type="text" id="new-tx-desc" placeholder="Description" class="border rounded p-2">
                        <input type="number" id="new-tx-amount" placeholder="Amount (KES)" class="border rounded p-2">
                        <input type="date" id="new-tx-date" class="border rounded p-2" value="${new Date().toISOString().split('T')[0]}">
                        <select id="new-tx-branch" class="border rounded p-2">${branchOptions}</select>
                    </div>
                     <div class="mt-4 text-right">
                        <button onclick="addTransaction('business')" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Add Transaction</button>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-700">Recent Transactions</h3>
                    <div class="overflow-x-auto text-sm border rounded-lg h-96">
                        <table class="min-w-full divide-y"><thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="p-2 text-left uppercase">Date</th><th class="p-2 text-left uppercase">Description</th>
                                <th class="p-2 text-left uppercase">Category</th><th class="p-2 text-left uppercase">Amount</th>
                                <th class="p-2 text-left uppercase">Action</th>
                            </tr></thead>
                            <tbody class="divide-y">${transactions.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => `
                                <tr class="${t.transactionType === 'income' ? 'bg-green-50' : 'bg-red-50'}">
                                    <td class="p-2">${t.date}</td><td class="p-2">${t.description}</td>
                                    <td class="p-2">${t.category}</td><td class="p-2">${formatCurrency(t.amount)}</td>
                                    <td class="p-2"><button class="text-red-600 text-xs font-semibold" onclick="deleteTransaction('${t.id}')">DELETE</button></td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        async function addTransaction(type) {
            if(type === 'business') {
                const newTx = {
                    type: 'business',
                    transactionType: document.getElementById('new-tx-type').value,
                    category: document.getElementById('new-tx-category').value,
                    description: document.getElementById('new-tx-desc').value,
                    amount: parseFloat(document.getElementById('new-tx-amount').value),
                    date: document.getElementById('new-tx-date').value,
                    branchId: document.getElementById('new-tx-branch').value
                };
                if(!newTx.description || !newTx.amount || !newTx.date) { showAlert("Date, Description and Amount are required."); return; }
                
                await db.collection('transactions').add(newTx);
                await fetchAllData();
                renderBusinessFinance();
                document.getElementById('new-tx-desc').value = '';
                document.getElementById('new-tx-amount').value = '';
            }
        }
        async function deleteTransaction(id) {
            if (confirm("Are you sure you want to delete this transaction?")) {
                await db.collection('transactions').doc(id).delete();
                await fetchAllData();
                renderBusinessFinance();
            }
        }

        // --- TASK ASSIGNMENT ---
        function renderTaskAssignment() {
            const container = document.getElementById('task-assignment-screen');
            const taskStatuses = data.tasks.reduce((acc, t) => { acc[t.status] = (acc[t.status] || 0) + 1; return acc; }, {});
            container.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div class="bg-gray-100 p-4 rounded-lg"><h3 class="font-bold">Total Tasks</h3><p class="text-2xl">${data.tasks.length}</p></div>
                    <div class="bg-yellow-100 p-4 rounded-lg"><h3 class="font-bold">Pending</h3><p class="text-2xl">${taskStatuses['Pending'] || 0}</p></div>
                    <div class="bg-blue-100 p-4 rounded-lg"><h3 class="font-bold">In Progress</h3><p class="text-2xl">${taskStatuses['In Progress'] || 0}</p></div>
                    <div class="bg-green-100 p-4 rounded-lg"><h3 class="font-bold">Completed</h3><p class="text-2xl">${taskStatuses['Completed'] || 0}</p></div>
                    <div class="bg-red-100 p-4 rounded-lg"><h3 class="font-bold">Rejected</h3><p class="text-2xl">${taskStatuses['Rejected'] || 0}</p></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>
                            <th class="p-2 text-left text-xs font-medium uppercase">Task Title</th>
                            <th class="p-2 text-left text-xs font-medium uppercase">Branch</th>
                            <th class="p-2 text-left text-xs font-medium uppercase">Staff</th>
                            <th class="p-2 text-left text-xs font-medium uppercase">Due Date</th>
                            <th class="p-2 text-left text-xs font-medium uppercase">Status</th>
                            <th class="p-2 text-left text-xs font-medium uppercase">Action</th>
                        </tr></thead>
                        <tbody id="task-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>`;
            renderTaskTable();
        }
        function renderTaskTable() {
             const tableBody = document.getElementById('task-table-body');
             const rowsHtml = data.tasks.map(t => {
                const branch = data.branches.find(b => b.id === t.branchId)?.name || 'N/A';
                const staff = data.users.find(u => u.id === t.staffId)?.fullName || 'N/A';
                return `<tr>
                    <td class="p-2">${t.title}</td><td>${branch}</td>
                    <td>${staff}</td><td>${t.dueDate}</td><td>${t.status}</td>
                    <td class="p-2"><button class="bg-red-500 text-white px-2 py-1 rounded text-xs" onclick="deleteTask('${t.id}')">Delete</button></td>
                </tr>`}).join('');
            
             const branchOptions = data.branches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
             const staffOptions = data.users.map(u => `<option value="${u.id}">${u.fullName}</option>`).join('');
             const addNewRowHtml = `
                <tr class="bg-gray-100">
                    <td class="p-2"><input type="text" id="new-task-title" placeholder="Task Title" class="w-full border rounded p-1"></td>
                    <td class="p-2"><select id="new-task-branchId" class="w-full border rounded p-1">${branchOptions}</select></td>
                    <td class="p-2"><select id="new-task-staffId" class="w-full border rounded p-1">${staffOptions}</select></td>
                    <td class="p-2"><input type="date" id="new-task-dueDate" class="w-full border rounded p-1"></td>
                    <td class="p-2"></td>
                    <td class="p-2"><button class="bg-green-600 text-white px-3 py-1 rounded flex items-center justify-center gap-1" onclick="addTask()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Add Task
                    </button></td>
                </tr>`;
             tableBody.innerHTML = rowsHtml + addNewRowHtml;
        }

        async function addTask() {
            const title = document.getElementById('new-task-title').value;
            if(!title) { showAlert("Task title is required."); return; }
            const newTask = {
                title: title,
                branchId: document.getElementById('new-task-branchId').value,
                staffId: document.getElementById('new-task-staffId').value,
                dueDate: document.getElementById('new-task-dueDate').value,
                notes: '',
                status: 'Pending'
            };
            await db.collection('tasks').add(newTask);
            await fetchAllData();
            renderTaskAssignment();
        }
        async function deleteTask(id) {
            if (confirm("Are you sure?")) {
                await db.collection('tasks').doc(id).delete();
                await fetchAllData();
                renderTaskAssignment();
            }
        }
        async function updateTaskStatus(taskId, newStatus) {
            await db.collection('tasks').doc(taskId).update({ status: newStatus });
            showAlert(`Task status updated to "${newStatus}".`);
            if(currentUser.role === 'admin') {
                await fetchAllData();
                renderAdminDashboard();
            }
        }
        
        // --- OTHER MANAGEMENT SCREENS (STUBS FOR BREVITY, REQUIRE SIMILAR FIREBASE REFACTORING) ---
        function renderReports() { showAlert("Reports are being upgraded."); }
        function renderProductManagement() { showAlert("Product management is being upgraded."); }
        function renderServiceManagement() { showAlert("Service management is being upgraded."); }
        function renderStaffManagement() { showAlert("Staff management is being upgraded."); }
        function renderBranchManagement() { showAlert("Branch management is being upgraded."); }
        function renderCustomerManagement() { showAlert("Customer management is being upgraded."); }
        function renderFindOrderScreen() { 
             document.getElementById('order-search-input').value = '';
             document.getElementById('order-search-results').innerHTML = '<p class="text-gray-500">Search for an order to see results.</p>';
        }
        
        // --- INITIALIZATION ---
        setInterval(updateTime, 1000);
        updateTime();
    </script>
</body>
</html>